<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- to make responsive -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- include bootstrap css -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" />

    <!-- include jquery and bootstrap js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/js/bootstrap.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/gh/xcash/bootstrap-autocomplete@v2.3.7/dist/latest/bootstrap-autocomplete.min.js"></script>

    <!-- include sweetalert for displaying dialog messages -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"></script>
    <title>Time recorder</title>
</head>

<body>

    <div class="container" style="margin-top: 50px; margin-bottom: 50px;">
        <div class="row">
            <div class="col-sm" style="margin-bottom: 30px;">
                <input placeholder="What are you doing?" class="form-control autoComplete" type="text" autocomplete="off">
            </div>
            <div class="col-sm">
                <button type="button" id="startBtn" class="btn btn-primary disabled">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-play-btn" viewBox="0 0 16 16">
                        <path d="M6.79 5.093A.5.5 0 0 0 6 5.5v5a.5.5 0 0 0 .79.407l3.5-2.5a.5.5 0 0 0 0-.814l-3.5-2.5z">
                        </path>
                        <path
                            d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4zm15 0a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4z">
                        </path>
                    </svg>
                    Start
                </button>
                <button type="button" id="stopBtn" class="btn btn-primary" style="display:none">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-stop-btn" viewBox="0 0 16 16">
                        <path
                            d="M6.5 5A1.5 1.5 0 0 0 5 6.5v3A1.5 1.5 0 0 0 6.5 11h3A1.5 1.5 0 0 0 11 9.5v-3A1.5 1.5 0 0 0 9.5 5h-3z" />
                        <path
                            d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4zm15 0a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4z" />
                    </svg>
                    Stop
                </button>
            </div>
        </div>
        <div class="row">
            <div class="col-sm">
                <table class="table">
                    <thead>
                        <tr>
                            <th scope="col">Task</th>
                            <th scope="col">Time</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>
        </div>
    </div>


    <script>

        const TaskManager = class {
            static get keywords() { return ['support', 'avant-vente', 'appel']; }

            constructor() {
                const tasksJson = window.localStorage.getItem('tasks');
                if (tasksJson) this.tasks = JSON.parse(tasksJson);
                else this.tasks = [];
                this.intervalId = -1;
                this.drawTable();
            }

            getAutocomplete(qry) {
                let taskNames = {};
                this.tasks.forEach(t => taskNames[t.name] = 1);
                let results = [];
                for(var i in taskNames) results.push(i);
                return results;
            }

            start(name) {
                this.tasks.unshift({
                    start: Date.now(),
                    end: undefined,
                    name: name
                });
                this.intervalId = setInterval(() => this.drawTable(), 1000);
                this.save();
            }
            stop() {
                this.tasks[0].end = Date.now();
                clearInterval(this.intervalId);
                this.save();
            }
            getToday() {
                const result = {};
                let notEnded;
                this.tasks.forEach(task => {
                    const duration = (task.end ? task.end : Date.now()) - task.start;
                    if (result[task.name]) result[task.name] += duration;
                    else result[task.name] = duration;
                    if(!task.end) notEnded = task.name;
                });
                if(notEnded) document.title = notEnded + ' ' + getYoutubeLikeToDisplay(result[notEnded]);
                return result;
            }
            
            drawTable() {
                let html = '';
                const data = this.getToday();
                for (var i in data) {
                    html += `<tr><td>${i}</td><td>${getYoutubeLikeToDisplay(data[i])}</td></tr>`;
                }
                $('#tableBody').html(html);
            }
            save() {
                window.localStorage.setItem('tasks', JSON.stringify(this.tasks));
            }
        };

        const tm = new TaskManager();

        // register the events
        $('.autoComplete').autoComplete({
            resolver: 'custom',
            events: {
                search: function (qry, callback) {
                    callback(tm.getAutocomplete(qry));
                }
            }
        });

        $('.autoComplete').keypress(evt => {
            if ($('.autoComplete').val().length > 2) $('#startBtn').removeClass('disabled');
            else $('#startBtn').addClass('disabled');
            if($('#stopBtn').is(':visible')) {
                tm.stop();
                $('#startBtn').show();
                $('#stopBtn').hide();
            }
        });

        $('#startBtn').click(event => {
            const task = $('.autoComplete').val();
            tm.start(task);
            $('#startBtn').hide();
            $('#stopBtn').show();
        });

        $('#stopBtn').click(event => {
            tm.stop();
            $('#startBtn').show();
            $('#stopBtn').hide();
        });


        function getYoutubeLikeToDisplay(millisec) {
        var seconds = (millisec / 1000).toFixed(0);
        var minutes = Math.floor(seconds / 60);
        var hours = "";
        if (minutes > 59) {
            hours = Math.floor(minutes / 60);
            hours = (hours >= 10) ? hours : "0" + hours;
            minutes = minutes - (hours * 60);
            minutes = (minutes >= 10) ? minutes : "0" + minutes;
        }

        seconds = Math.floor(seconds % 60);
        seconds = (seconds >= 10) ? seconds : "0" + seconds;
        if (hours != "") {
            return hours + ":" + minutes + ":" + seconds;
        }
        return minutes + ":" + seconds;
    }

    </script>
</body>

</html>